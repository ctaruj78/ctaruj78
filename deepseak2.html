<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiftMaster Pro - Дашборд</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { 
            background-color: #f4f6f9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .sidebar { 
            height: 100vh; 
            background: #1f2d3d; 
            color: white; 
            padding-top: 1rem;
            position: fixed;
            width: 250px;
        }
        .sidebar a { 
            color: white; 
            display: block; 
            padding: 0.75rem 1rem; 
            text-decoration: none;
            transition: all 0.3s;
        }
        .sidebar a:hover { 
            background: #2c3e50; 
            transform: translateX(5px);
        }
        .sidebar a.active {
            background: #007bff;
        }
        .sidebar a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .card { 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: none;
        }
        #map { 
            height: 300px; 
            width: 100%; 
            border-radius: 0.75rem; 
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .stat-card {
            transition: all 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }
        .notification {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .badge {
            font-weight: 500;
            padding: 0.5em 0.75em;
        }
        .form-section {
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .table-responsive {
            border-radius: 0.75rem;
            overflow: hidden;
        }
        .table th {
            background-color: #2c3e50;
            color: white;
            cursor: pointer;
        }
        .table th:hover {
            background-color: #1a252f;
        }
        .pagination .page-item.active .page-link {
            background-color: #2c3e50;
            border-color: #2c3e50;
        }
        .pagination .page-link {
            color: #2c3e50;
        }
        .action-btn {
            margin-right: 5px;
            min-width: 80px;
        }
        .user-role-badge {
            font-size: 0.9rem;
            padding: 0.35em 0.65em;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h4 class="text-center mb-4"><i class="fas fa-elevator"></i> LiftMaster Pro</h4>
        <a href="#" class="active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i> Дашборд</a>
        <a href="#" onclick="showSection('lifts')"><i class="fas fa-elevator"></i> Ліфти</a>
        <a href="#" onclick="showSection('issues')" id="issuesMenu" style="display: none;"><i class="fas fa-exclamation-triangle"></i> Заявки</a>
        <a href="#" onclick="showSection('myIssues')" id="myIssuesMenu" style="display: none;"><i class="fas fa-exclamation-circle"></i> Мої заявки</a>
        <a href="#" onclick="showSection('clients')" id="clientsMenu"><i class="fas fa-users"></i> Клієнти</a>
        <a href="#" onclick="showSection('analytics')" id="analyticsMenu"><i class="fas fa-chart-line"></i> Аналітика</a>
        <a href="#" onclick="showSection('reports')"><i class="fas fa-file-pdf"></i> Звіти</a>
        <a href="#" id="qrScannerMenu" style="display: none;"><i class="fas fa-qrcode"></i> QR Сканер</a>
        <a href="#" onclick="showSection('settings')"><i class="fas fa-cog"></i> Налаштування</a>
        <a href="#" onclick="logout()" style="position: absolute; bottom: 20px; width: calc(100% - 2rem);"><i class="fas fa-sign-out-alt"></i> Вийти</a>
    </div>

    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboard-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Головна панель</h2>
                <span class="badge bg-primary user-role-badge" id="userRoleBadge">Адміністратор</span>
            </div>

            <div class="alert alert-danger notification" id="urgentNotification" style="display: none;">
                <i class="fas fa-exclamation-circle me-2"></i>Увага! Є термінові заявки, які потребують вашої уваги.
            </div>

            <!-- Map -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-map-marked-alt me-2"></i>Карта ліфтів</h5>
                    <div id="map"></div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card text-white bg-success stat-card">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-elevator me-2"></i>Активні ліфти</h5>
                            <p class="fs-3 mb-0" id="activeLifts">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-warning stat-card">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-tasks me-2"></i>Завдання на сьогодні</h5>
                            <p class="fs-3 mb-0" id="todayIssues">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-info stat-card">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-clock me-2"></i>Сер. час реакції</h5>
                            <p class="fs-3 mb-0" id="reclamationTime">0 год</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0"><i class="fas fa-bolt me-2"></i>Швидкі дії</h5>
                                <div>
                                    <button class="btn btn-primary me-2" id="toggleNewLiftForm" style="display: none;" onclick="toggleForm('newLiftForm')">
                                        <i class="fas fa-plus me-1"></i>Додати ліфт
                                    </button>
                                    <button class="btn btn-success" id="toggleNewIssueForm" style="display: none;" onclick="toggleForm('newIssueForm')">
                                        <i class="fas fa-plus me-1"></i>Нова заявка
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Lifts Table -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0"><i class="fas fa-elevator me-2"></i>Останні ліфти</h5>
                        <div class="input-group" style="width: 300px;">
                            <input type="text" class="form-control" placeholder="Пошук..." id="dashboardSearchInput" onkeyup="filterDashboardTable()">
                            <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover" id="dashboardLiftTable">
                            <thead>
                                <tr>
                                    <th onclick="sortDashboardTable(0)">ID <i class="fas fa-sort"></i></th>
                                    <th onclick="sortDashboardTable(1)">Адреса <i class="fas fa-sort"></i></th>
                                    <th onclick="sortDashboardTable(2)">Статус <i class="fas fa-sort"></i></th>
                                    <th onclick="sortDashboardTable(3)">Останнє ТО <i class="fas fa-sort"></i></th>
                                    <th>Дії</th>
                                </tr>
                            </thead>
                            <tbody id="dashboardLiftTableBody"></tbody>
                        </table>
                    </div>
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination justify-content-center" id="dashboardPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Lifts Section -->
        <div id="lifts-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0"><i class="fas fa-elevator me-2"></i>Управління ліфтами</h2>
                <button class="btn btn-primary" id="toggleLiftsForm" onclick="toggleForm('newLiftForm')">
                    <i class="fas fa-plus me-1"></i>Додати ліфт
                </button>
            </div>

            <!-- New Lift Form -->
            <div class="card form-section" id="newLiftForm">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-plus-circle me-2"></i>Додати новий ліфт</h5>
                    <form id="addLiftForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="newLiftId" class="form-label">ID ліфта <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="newLiftId" placeholder="Унікальний ідентифікатор" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="newLiftAddress" class="form-label">Адреса <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="newLiftAddress" placeholder="Повна адреса" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="newLiftType" class="form-label">Тип ліфта</label>
                                <input type="text" class="form-control" id="newLiftType" placeholder="Наприклад, Пасажирський">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="newLiftBrand" class="form-label">Марка</label>
                                <input type="text" class="form-control" id="newLiftBrand" placeholder="Наприклад, Otis">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="newLiftCapacity" class="form-label">Вантажопідйомність</label>
                                <input type="text" class="form-control" id="newLiftCapacity" placeholder="Наприклад, 1000 кг">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="newLiftInstallationDate" class="form-label">Дата встановлення</label>
                                <input type="date" class="form-control" id="newLiftInstallationDate">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="newLiftStatus" class="form-label">Статус <span class="text-danger">*</span></label>
                                <select class="form-select" id="newLiftStatus" required>
                                    <option value="Активний">Активний</option>
                                    <option value="Поломка">Поломка</option>
                                    <option value="Технічне обслуговування">Технічне обслуговування</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="newLiftOwner" class="form-label">Власник (email)</label>
                                <input type="email" class="form-control" id="newLiftOwner" placeholder="Email власника">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="newLiftPhoto" class="form-label">Фото ліфта (опціонально)</label>
                                <input type="file" class="form-control" id="newLiftPhoto" accept="image/*">
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" onclick="toggleForm('newLiftForm')">Скасувати</button>
                            <button type="button" class="btn btn-primary" onclick="addNewLift()">Додати ліфт</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Lift Form -->
            <div class="card form-section" id="editLiftForm" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-edit me-2"></i>Редагувати ліфт</h5>
                    <form id="editLiftFormContent">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editLiftId" class="form-label">ID ліфта</label>
                                <input type="text" class="form-control" id="editLiftId" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editLiftAddress" class="form-label">Адреса <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editLiftAddress" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="editLiftType" class="form-label">Тип ліфта</label>
                                <input type="text" class="form-control" id="editLiftType">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editLiftBrand" class="form-label">Марка</label>
                                <input type="text" class="form-control" id="editLiftBrand">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editLiftCapacity" class="form-label">Вантажопідйомність</label>
                                <input type="text" class="form-control" id="editLiftCapacity">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="editLiftInstallationDate" class="form-label">Дата встановлення</label>
                                <input type="date" class="form-control" id="editLiftInstallationDate">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editLiftStatus" class="form-label">Статус <span class="text-danger">*</span></label>
                                <select class="form-select" id="editLiftStatus" required>
                                    <option value="Активний">Активний</option>
                                    <option value="Поломка">Поломка</option>
                                    <option value="Технічне обслуговування">Технічне обслуговування</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editLiftLastMaintenance" class="form-label">Останнє ТО</label>
                                <input type="date" class="form-control" id="editLiftLastMaintenance">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="editLiftPhoto" class="form-label">Оновити фото ліфта</label>
                                <input type="file" class="form-control" id="editLiftPhoto" accept="image/*">
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" onclick="toggleForm('editLiftForm')">Скасувати</button>
                            <button type="button" class="btn btn-primary" onclick="saveLiftEdit()">Зберегти зміни</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Filter and Search -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <div class="input-group">
                                <input type="text" class="form-control" id="liftsSearchInput" placeholder="Пошук за ID, адресою, маркою..." onkeyup="filterLifts()">
                                <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3 mb-md-0">
                            <select class="form-select" id="liftsStatusFilter" onchange="filterLifts()">
                                <option value="all">Усі статуси</option>
                                <option value="Активний">Активний</option>
                                <option value="Поломка">Поломка</option>
                                <option value="Технічне обслуговування">Технічне обслуговування</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-primary w-100" onclick="exportToCSV('lifts')">
                                <i class="fas fa-download me-1"></i>Експорт у CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lifts Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="liftsTable">
                            <thead>
                                <tr>
                                    <th onclick="sortTable('lifts', 0)">ID <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('lifts', 1)">Адреса <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('lifts', 2)">Тип <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('lifts', 3)">Марка <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('lifts', 4)">Статус <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('lifts', 5)">Останнє ТО <i class="fas fa-sort"></i></th>
                                    <th>Дії</th>
                                </tr>
                            </thead>
                            <tbody id="liftsTableBody"></tbody>
                        </table>
                    </div>
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination justify-content-center" id="liftsPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Issues Section -->
        <div id="issues-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Управління заявками</h2>
                <button class="btn btn-success" id="toggleIssuesForm" onclick="toggleForm('newIssueForm')">
                    <i class="fas fa-plus me-1"></i>Нова заявка
                </button>
            </div>

            <!-- New Issue Form -->
            <div class="card form-section" id="newIssueForm">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-plus-circle me-2"></i>Нова заявка</h5>
                    <form id="addIssueForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="newIssueLiftId" class="form-label">ID ліфта <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="newIssueLiftId" placeholder="Введіть ID ліфта" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="newIssuePriority" class="form-label">Пріоритет <span class="text-danger">*</span></label>
                                <select class="form-select" id="newIssuePriority" required>
                                    <option value="Низький">Низький</option>
                                    <option value="Середній">Середній</option>
                                    <option value="Високий">Високий</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="newIssueDescription" class="form-label">Опис проблеми <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="newIssueDescription" rows="3" placeholder="Детальний опис проблеми" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="newIssuePhoto" class="form-label">Фото/відео проблеми (опціонально)</label>
                            <input type="file" class="form-control" id="newIssuePhoto" accept="image/*,video/*">
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" onclick="toggleForm('newIssueForm')">Скасувати</button>
                            <button type="button" class="btn btn-primary me-2" onclick="submitNewIssue()">Надіслати</button>
                            <button type="button" class="btn btn-success" onclick="sendIssueToEmail()">
                                <i class="fas fa-envelope me-1"></i>На Email
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Filter and Search -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3 mb-md-0">
                            <div class="input-group">
                                <input type="text" class="form-control" id="issuesSearchInput" placeholder="Пошук за ID, описом..." onkeyup="filterIssues()">
                                <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3 mb-md-0">
                            <select class="form-select" id="issuesStatusFilter" onchange="filterIssues()">
                                <option value="all">Усі статуси</option>
                                <option value="Нова">Нова</option>
                                <option value="В роботі">В роботі</option>
                                <option value="Завершена">Завершена</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3 mb-md-0">
                            <select class="form-select" id="issuesPriorityFilter" onchange="filterIssues()">
                                <option value="all">Усі пріоритети</option>
                                <option value="Низький">Низький</option>
                                <option value="Середній">Середній</option>
                                <option value="Високий">Високий</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-primary w-100" onclick="exportToCSV('issues')">
                                <i class="fas fa-download me-1"></i>Експорт
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Issues Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="issuesTable">
                            <thead>
                                <tr>
                                    <th onclick="sortTable('issues', 0)">ID <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('issues', 1)">ID Ліфта <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('issues', 2)">Опис <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('issues', 3)">Пріоритет <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('issues', 4)">Клієнт <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('issues', 5)">Технік <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('issues', 6)">Статус <i class="fas fa-sort"></i></th>
                                    <th>Дії</th>
                                </tr>
                            </thead>
                            <tbody id="issuesTableBody"></tbody>
                        </table>
                    </div>
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination justify-content-center" id="issuesPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>

        <!-- My Issues Section -->
        <div id="my-issues-section" style="display: none;">
            <h2 class="mb-4"><i class="fas fa-exclamation-circle me-2"></i>Мої заявки</h2>
            
            <!-- Filter and Search -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <div class="input-group">
                                <input type="text" class="form-control" id="myIssuesSearchInput" placeholder="Пошук за ID, описом..." onkeyup="filterMyIssues()">
                                <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3 mb-md-0">
                            <select class="form-select" id="myIssuesStatusFilter" onchange="filterMyIssues()">
                                <option value="all">Усі статуси</option>
                                <option value="Нова">Нова</option>
                                <option value="В роботі">В роботі</option>
                                <option value="Завершена">Завершена</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-primary w-100" onclick="exportToCSV('myIssues')">
                                <i class="fas fa-download me-1"></i>Експорт
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Issues Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="myIssuesTable">
                            <thead>
                                <tr>
                                    <th onclick="sortTable('myIssues', 0)">ID <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('myIssues', 1)">ID Ліфта <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('myIssues', 2)">Опис <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('myIssues', 3)">Пріоритет <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('myIssues', 4)">Статус <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('myIssues', 5)">Технік <i class="fas fa-sort"></i></th>
                                    <th>Дії</th>
                                </tr>
                            </thead>
                            <tbody id="myIssuesTableBody"></tbody>
                        </table>
                    </div>
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination justify-content-center" id="myIssuesPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings-section" style="display: none;">
            <h2 class="mb-4"><i class="fas fa-cog me-2"></i>Налаштування</h2>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-user-cog me-2"></i>Профіль</h5>
                            <form id="profileForm">
                                <div class="mb-3">
                                    <label for="userName" class="form-label">Ім'я</label>
                                    <input type="text" class="form-control" id="userName" value="Адміністратор">
                                </div>
                                <div class="mb-3">
                                    <label for="userEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="userEmail" value="admin@example.com" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="userPhone" class="form-label">Телефон</label>
                                    <input type="tel" class="form-control" id="userPhone" placeholder="+380XXXXXXXXX">
                                </div>
                                <button type="button" class="btn btn-primary">Оновити профіль</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-globe me-2"></i>Системні налаштування</h5>
                            <form id="systemSettingsForm">
                                <div class="mb-3">
                                    <label for="languageSelect" class="form-label">Мова</label>
                                    <select class="form-select" id="languageSelect">
                                        <option value="uk">Українська</option>
                                        <option value="en">English</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="dateFormatSelect" class="form-label">Формат дати</label>
                                    <select class="form-select" id="dateFormatSelect">
                                        <option value="DD.MM.YYYY">ДД.ММ.РРРР</option>
                                        <option value="MM/DD/YYYY">ММ/ДД/РРРР</option>
                                        <option value="YYYY-MM-DD">РРРР-ММ-ДД</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="timeZoneSelect" class="form-label">Часовий пояс</label>
                                    <select class="form-select" id="timeZoneSelect">
                                        <option value="Europe/Kiev">Київ (UTC+2/+3)</option>
                                        <option value="UTC">UTC</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="saveSettings()">Зберегти налаштування</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title text-danger"><i class="fas fa-shield-alt me-2"></i>Безпека</h5>
                    <div class="mb-3">
                        <button class="btn btn-outline-danger" onclick="changePassword()">
                            <i class="fas fa-key me-1"></i>Змінити пароль
                        </button>
                    </div>
                    <div class="mb-3">
                        <button class="btn btn-outline-secondary" onclick="exportAllData()">
                            <i class="fas fa-database me-1"></i>Експорт всіх даних
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-outline-dark" onclick="deleteAccount()">
                            <i class="fas fa-user-slash me-1"></i>Видалити акаунт
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Data initialization
        const user = JSON.parse(localStorage.getItem('user')) || { 
            role: 'admin', 
            email: 'admin@example.com',
            name: 'Адміністратор'
        };
        
        let lifts = JSON.parse(localStorage.getItem('lifts')) || [
            { 
                id: "34", 
                address: "вул. Перемоги, 12", 
                type: "Пасажирський", 
                brand: "Otis", 
                installationDate: "2015-06-20", 
                capacity: "1000 кг", 
                status: "Поломка", 
                lastMaintenance: "2025-03-13", 
                owner: "client1@example.com",
                photo: null,
                coordinates: [49.8397, 24.0297]
            },
            { 
                id: "78", 
                address: "пр. Миру, 45", 
                type: "Пасажирський", 
                brand: "KONE", 
                installationDate: "2018-09-15", 
                capacity: "800 кг", 
                status: "Активний", 
                lastMaintenance: "2025-03-29", 
                owner: "client2@example.com",
                photo: null,
                coordinates: [49.845, 24.03]
            }
        ];
        
        let issues = JSON.parse(localStorage.getItem('issues')) || [];
        let technicians = JSON.parse(localStorage.getItem('technicians')) || [
            { id: "tech1", name: "Іван Петров", email: "tech1@example.com" },
            { id: "tech2", name: "Олег Сидоров", email: "tech2@example.com" }
        ];
        
        let settings = JSON.parse(localStorage.getItem('settings')) || { 
            language: 'uk', 
            dateFormat: 'DD.MM.YYYY',
            timeZone: 'Europe/Kiev'
        };
        
        // Pagination and sorting
        let currentPage = {
            dashboard: 1,
            lifts: 1,
            issues: 1,
            myIssues: 1
        };
        
        const itemsPerPage = 10;
        let sortState = {
            lifts: { column: -1, direction: 1 },
            issues: { column: -1, direction: 1 },
            myIssues: { column: -1, direction: 1 },
            dashboard: { column: -1, direction: 1 }
        };
        
        // Map initialization
        let map;
        let markers = [];
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            setupRoleAccess();
            initMap();
            displayDashboard();
            setupEventListeners();
        });
        
        function setupRoleAccess() {
            // Set user role badge
            const roleBadge = document.getElementById('userRoleBadge');
            let roleText = '';
            
            switch(user.role) {
                case 'admin':
                    roleText = 'Адміністратор';
                    roleBadge.className = 'badge bg-primary user-role-badge';
                    break;
                case 'technician':
                    roleText = 'Технік';
                    roleBadge.className = 'badge bg-warning user-role-badge';
                    break;
                case 'client':
                    roleText = 'Клієнт';
                    roleBadge.className = 'badge bg-success user-role-badge';
                    break;
                default:
                    roleText = 'Гість';
                    roleBadge.className = 'badge bg-secondary user-role-badge';
            }
            
            roleBadge.textContent = roleText;
            
            // Show/hide menu items based on role
            if (user.role === 'technician') {
                document.getElementById('statsSection').style.display = 'none';
                document.getElementById('clientsMenu').style.display = 'none';
                document.getElementById('analyticsMenu').style.display = 'none';
                document.getElementById('qrScannerMenu').style.display = 'block';
                document.getElementById('toggleNewLiftForm').style.display = 'none';
                document.getElementById('toggleNewIssueForm').style.display = 'block';
                document.getElementById('issuesMenu').style.display = 'block';
            } else if (user.role === 'client') {
                document.getElementById('clientsMenu').style.display = 'none';
                document.getElementById('analyticsMenu').style.display = 'none';
                document.getElementById('toggleNewLiftForm').style.display = 'none';
                document.getElementById('toggleNewIssueForm').style.display = 'block';
                document.getElementById('myIssuesMenu').style.display = 'block';
            } else if (user.role === 'admin') {
                document.getElementById('toggleNewLiftForm').style.display = 'block';
                document.getElementById('toggleNewIssueForm').style.display = 'block';
                document.getElementById('issuesMenu').style.display = 'block';
            }
        }
        
        function initMap() {
            map = L.map('map').setView([49.8397, 24.0297], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data © OpenStreetMap contributors'
            }).addTo(map);
            
            updateMapMarkers();
        }
        
        function updateMapMarkers() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Add new markers based on lifts data
            lifts.forEach(lift => {
                if (lift.coordinates && lift.coordinates.length === 2) {
                    const marker = L.marker(lift.coordinates).addTo(map)
                        .bindPopup(`
                            <b>Ліфт №${lift.id}</b><br>
                            <b>Адреса:</b> ${lift.address}<br>
                            <b>Статус:</b> <span style="color: ${lift.status === 'Активний' ? 'green' : 'red'}">${lift.status}</span><br>
                            <button class="btn btn-sm btn-primary mt-1" onclick="viewLiftDetails('${lift.id}')">Деталі</button>
                        `);
                    
                    markers.push(marker);
                }
            });
        }
        
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('[id$="-section"]').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show the selected section
            document.getElementById(`${sectionId}-section`).style.display = 'block';
            
            // Update active menu item
            document.querySelectorAll('.sidebar a').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load data for the section
            switch(sectionId) {
                case 'dashboard':
                    displayDashboard();
                    break;
                case 'lifts':
                    displayLifts();
                    break;
                case 'issues':
                    displayIssues();
                    break;
                case 'myIssues':
                    displayMyIssues();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }
        
        function toggleForm(formId) {
            const form = document.getElementById(formId);
            form.style.display = form.style.display === 'block' ? 'none' : 'block';
        }
        
        function displayDashboard() {
            displayDashboardLifts();
            updateStats();
            checkUrgentIssues();
        }
        
        function displayDashboardLifts() {
            const tableBody = document.getElementById('dashboardLiftTableBody');
            tableBody.innerHTML = '';
            
            let filteredLifts = filterData(lifts, 'dashboard');
            const sortedLifts = sortData(filteredLifts, 'dashboard');
            const paginatedLifts = paginateData(sortedLifts, 'dashboard');
            
            paginatedLifts.forEach(lift => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${lift.id}</td>
                    <td>${lift.address}</td>
                    <td><span class="badge ${lift.status === 'Активний' ? 'bg-success' : lift.status === 'Поломка' ? 'bg-danger' : 'bg-warning'}">${lift.status}</span></td>
                    <td>${formatDate(lift.lastMaintenance)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary action-btn" onclick="viewLiftDetails('${lift.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${user.role === 'admin' || user.role === 'technician' ? `
                        <button class="btn btn-sm btn-warning action-btn" onclick="editLift('${lift.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        ` : ''}
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            updatePagination(filteredLifts.length, 'dashboard');
        }
        
        function displayLifts() {
            const tableBody = document.getElementById('liftsTableBody');
            tableBody.innerHTML = '';
            
            let filteredLifts = filterData(lifts, 'lifts');
            const sortedLifts = sortData(filteredLifts, 'lifts');
            const paginatedLifts = paginateData(sortedLifts, 'lifts');
            
            paginatedLifts.forEach(lift => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${lift.id}</td>
                    <td>${lift.address}</td>
                    <td>${lift.type || '-'}</td>
                    <td>${lift.brand || '-'}</td>
                    <td><span class="badge ${lift.status === 'Активний' ? 'bg-success' : lift.status === 'Поломка' ? 'bg-danger' : 'bg-warning'}">${lift.status}</span></td>
                    <td>${formatDate(lift.lastMaintenance)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary action-btn" onclick="viewLiftDetails('${lift.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${user.role === 'admin' || user.role === 'technician' ? `
                        <button class="btn btn-sm btn-warning action-btn" onclick="editLift('${lift.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        ` : ''}
                        ${user.role === 'admin' ? `
                        <button class="btn btn-sm btn-danger action-btn" onclick="deleteLift('${lift.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            updatePagination(filteredLifts.length, 'lifts');
        }
        
        function displayIssues() {
            const tableBody = document.getElementById('issuesTableBody');
            tableBody.innerHTML = '';
            
            let filteredIssues = filterData(issues, 'issues');
            const sortedIssues = sortData(filteredIssues, 'issues');
            const paginatedIssues = paginateData(sortedIssues, 'issues');
            
            paginatedIssues.forEach(issue => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${issue.id}</td>
                    <td>${issue.liftId}</td>
                    <td>${issue.description}</td>
                    <td><span class="badge ${issue.priority === 'Високий' ? 'bg-danger' : issue.priority === 'Середній' ? 'bg-warning' : 'bg-info'}">${issue.priority}</span></td>
                    <td>${issue.client}</td>
                    <td>${issue.assignedTechnician ? technicians.find(t => t.email === issue.assignedTechnician)?.name || issue.assignedTechnician : 'Не призначено'}</td>
                    <td><span class="badge ${issue.status === 'Нова' ? 'bg-secondary' : issue.status === 'В роботі' ? 'bg-primary' : 'bg-success'}">${issue.status}</span></td>
                    <td>
                        ${user.role === 'admin' ? `
                            <select class="form-select form-select-sm" onchange="assignTechnician('${issue.id}', this.value)" style="width: 180px;">
                                <option value="">Призначити техніка</option>
                                ${technicians.map(tech => `<option value="${tech.email}" ${issue.assignedTechnician === tech.email ? 'selected' : ''}>${tech.name}</option>`).join('')}
                            </select>
                        ` : ''}
                        ${user.role === 'technician' ? `
                            <select class="form-select form-select-sm" onchange="updateIssueStatus('${issue.id}', this.value)" style="width: 150px;">
                                <option value="Нова" ${issue.status === 'Нова' ? 'selected' : ''}>Нова</option>
                                <option value="В роботі" ${issue.status === 'В роботі' ? 'selected' : ''}>В роботі</option>
                                <option value="Завершена" ${issue.status === 'Завершена' ? 'selected' : ''}>Завершена</option>
                            </select>
                        ` : ''}
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            updatePagination(filteredIssues.length, 'issues');
        }
        
        function displayMyIssues() {
            const tableBody = document.getElementById('myIssuesTableBody');
            tableBody.innerHTML = '';
            
            let myIssues = issues.filter(issue => issue.client === user.email);
            let filteredIssues = filterData(myIssues, 'myIssues');
            const sortedIssues = sortData(filteredIssues, 'myIssues');
            const paginatedIssues = paginateData(sortedIssues, 'myIssues');
            
            paginatedIssues.forEach(issue => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${issue.id}</td>
                    <td>${issue.liftId}</td>
                    <td>${issue.description}</td>
                    <td><span class="badge ${issue.priority === 'Високий' ? 'bg-danger' : issue.priority === 'Середній' ? 'bg-warning' : 'bg-info'}">${issue.priority}</span></td>
                    <td><span class="badge ${issue.status === 'Нова' ? 'bg-secondary' : issue.status === 'В роботі' ? 'bg-primary' : 'bg-success'}">${issue.status}</span></td>
                    <td>${issue.assignedTechnician ? technicians.find(t => t.email === issue.assignedTechnician)?.name || issue.assignedTechnician : 'Не призначено'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary action-btn" onclick="viewIssueDetails('${issue.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            updatePagination(filteredIssues.length, 'myIssues');
        }
        
        function filterData(data, section) {
            const searchInput = document.getElementById(`${section}SearchInput`);
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            let filteredData = [...data];
            
            // Apply role-based filtering
            if (section === 'lifts' && user.role === 'client') {
                filteredData = filteredData.filter(lift => lift.owner === user.email);
            }
            
            // Apply search filtering
            if (searchTerm) {
                filteredData = filteredData.filter(item => {
                    if (section === 'lifts' || section === 'dashboard') {
                        return (
                            item.id.toLowerCase().includes(searchTerm) ||
                            item.address.toLowerCase().includes(searchTerm) ||
                            (item.brand && item.brand.toLowerCase().includes(searchTerm)) ||
                            (item.type && item.type.toLowerCase().includes(searchTerm))
                        );
                    } else if (section === 'issues' || section === 'myIssues') {
                        return (
                            item.id.toLowerCase().includes(searchTerm) ||
                            item.liftId.toLowerCase().includes(searchTerm) ||
                            item.description.toLowerCase().includes(searchTerm) ||
                            item.client.toLowerCase().includes(searchTerm))
                        );
                    }
                    return true;
                });
            }
            
            // Apply status filtering
            const statusFilter = document.getElementById(`${section}StatusFilter`);
            if (statusFilter && statusFilter.value !== 'all') {
                filteredData = filteredData.filter(item => item.status === statusFilter.value);
            }
            
            // Apply priority filtering for issues
            const priorityFilter = document.getElementById(`${section}PriorityFilter`);
            if (priorityFilter && priorityFilter.value !== 'all') {
                filteredData = filteredData.filter(item => item.priority === priorityFilter.value);
            }
            
            return filteredData;
        }
        
        function sortData(data, section) {
            const sortCol = sortState[section].column;
            const sortDir = sortState[section].direction;
            
            if (sortCol === -1) return data;
            
            return [...data].sort((a, b) => {
                let valA, valB;
                
                if (section === 'lifts' || section === 'dashboard') {
                    const liftFields = ['id', 'address', 'type', 'brand', 'status', 'lastMaintenance'];
                    valA = a[liftFields[sortCol]] || '';
                    valB = b[liftFields[sortCol]] || '';
                } else if (section === 'issues' || section === 'myIssues') {
                    const issueFields = ['id', 'liftId', 'description', 'priority', 'client', 'assignedTechnician', 'status'];
                    valA = a[issueFields[sortCol]] || '';
                    valB = b[issueFields[sortCol]] || '';
                }
                
                if (typeof valA === 'string' && typeof valB === 'string') {
                    return valA.localeCompare(valB) * sortDir;
                }
                return (valA > valB ? 1 : -1) * sortDir;
            });
        }
        
        function paginateData(data, section) {
            const start = (currentPage[section] - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            return data.slice(start, end);
        }
        
        function updatePagination(totalItems, section) {
            const pagination = document.getElementById(`${section}Pagination`);
            if (!pagination) return;
            
            pagination.innerHTML = '';
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage[section] === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage('${section}', ${currentPage[section] - 1})">&laquo;</a>`;
            pagination.appendChild(prevLi);
            
            // Page buttons
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${currentPage[section] === i ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage('${section}', ${i})">${i}</a>`;
                pagination.appendChild(li);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage[section] === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage('${section}', ${currentPage[section] + 1})">&raquo;</a>`;
            pagination.appendChild(nextLi);
        }
        
        function changePage(section, page) {
            currentPage[section] = page;
            
            switch(section) {
                case 'dashboard':
                    displayDashboardLifts();
                    break;
                case 'lifts':
                    displayLifts();
                    break;
                case 'issues':
                    displayIssues();
                    break;
                case 'myIssues':
                    displayMyIssues();
                    break;
            }
        }
        
        function sortTable(section, column) {
            if (sortState[section].column === column) {
                sortState[section].direction *= -1;
            } else {
                sortState[section].column = column;
                sortState[section].direction = 1;
            }
            
            switch(section) {
                case 'dashboard':
                    displayDashboardLifts();
                    break;
                case 'lifts':
                    displayLifts();
                    break;
                case 'issues':
                    displayIssues();
                    break;
                case 'myIssues':
                    displayMyIssues();
                    break;
            }
        }
        
        function filterLifts() {
            currentPage.lifts = 1;
            displayLifts();
        }
        
        function filterIssues() {
            currentPage.issues = 1;
            displayIssues();
        }
        
        function filterMyIssues() {
            currentPage.myIssues = 1;
            displayMyIssues();
        }
        
        function filterDashboardTable() {
            currentPage.dashboard = 1;
            displayDashboardLifts();
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'Не вказано';
            const date = new Date(dateStr);
            
            if (isNaN(date.getTime())) return dateStr; // Return as-is if invalid date
            
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            
            switch(settings.dateFormat) {
                case 'MM/DD/YYYY':
                    return `${month}/${day}/${year}`;
                case 'YYYY-MM-DD':
                    return `${year}-${month}-${day}`;
                case 'DD.MM.YYYY':
                default:
                    return `${day}.${month}.${year}`;
            }
        }
        
        function addNewLift() {
            const id = document.getElementById('newLiftId').value.trim();
            const address = document.getElementById('newLiftAddress').value.trim();
            const type = document.getElementById('newLiftType').value.trim();
            const brand = document.getElementById('newLiftBrand').value.trim();
            const installationDate = document.getElementById('newLiftInstallationDate').value;
            const capacity = document.getElementById('newLiftCapacity').value.trim();
            const status = document.getElementById('newLiftStatus').value;
            const owner = document.getElementById('newLiftOwner').value.trim() || '';
            const photoFile = document.getElementById('newLiftPhoto').files[0];
            
            if (!id || !address) {
                alert('ID та Адреса є обов\'язковими полями!');
                return;
            }
            
            if (lifts.some(lift => lift.id === id)) {
                alert('Ліфт із таким ID вже існує!');
                return;
            }
            
            // Simple geocoding - in a real app, you would use a proper geocoding service
            const coordinates = address.includes('Перемоги') ? [49.8397, 24.0297] : 
                              address.includes('Миру') ? [49.845, 24.03] : null;
            
            const newLift = {
                id,
                address,
                type: type || null,
                brand: brand || null,
                installationDate: installationDate || null,
                capacity: capacity || null,
                status,
                lastMaintenance: '',
                owner: owner || null,
                photo: photoFile ? URL.createObjectURL(photoFile) : null,
                coordinates
            };
            
            lifts.push(newLift);
            localStorage.setItem('lifts', JSON.stringify(lifts));
            
            displayLifts();
            displayDashboardLifts();
            updateMapMarkers();
            toggleForm('newLiftForm');
            document.getElementById('addLiftForm').reset();
            
            alert(`Ліфт ${id} успішно додано!`);
        }
        
        function editLift(liftId) {
            const lift = lifts.find(l => l.id === liftId);
            if (!lift) return;
            
            document.getElementById('editLiftId').value = lift.id;
            document.getElementById('editLiftAddress').value = lift.address;
            document.getElementById('editLiftType').value = lift.type || '';
            document.getElementById('editLiftBrand').value = lift.brand || '';
            document.getElementById('editLiftInstallationDate').value = lift.installationDate || '';
            document.getElementById('editLiftCapacity').value = lift.capacity || '';
            document.getElementById('editLiftStatus').value = lift.status;
            document.getElementById('editLiftLastMaintenance').value = lift.lastMaintenance || '';
            
            toggleForm('editLiftForm');
        }
        
        function saveLiftEdit() {
            const id = document.getElementById('editLiftId').value;
            const lift = lifts.find(l => l.id === id);
            if (!lift) return;
            
            lift.address = document.getElementById('editLiftAddress').value.trim();
            lift.type = document.getElementById('editLiftType').value.trim() || null;
            lift.brand = document.getElementById('editLiftBrand').value.trim() || null;
            lift.installationDate = document.getElementById('editLiftInstallationDate').value || null;
            lift.capacity = document.getElementById('editLiftCapacity').value.trim() || null;
            lift.status = document.getElementById('editLiftStatus').value;
            lift.lastMaintenance = document.getElementById('editLiftLastMaintenance').value || null;
            
            const photoFile = document.getElementById('editLiftPhoto').files[0];
            if (photoFile) {
                lift.photo = URL.createObjectURL(photoFile);
            }
            
            // Update coordinates if address changed significantly
            if (!lift.coordinates || !lift.address.includes('Перемоги') && !lift.address.includes('Миру')) {
                lift.coordinates = lift.address.includes('Перемоги') ? [49.8397, 24.0297] : 
                                 lift.address.includes('Миру') ? [49.845, 24.03] : null;
            }
            
            localStorage.setItem('lifts', JSON.stringify(lifts));
            
            displayLifts();
            displayDashboardLifts();
            updateMapMarkers();
            toggleForm('editLiftForm');
            
            alert(`Зміни для ліфта ${id} збережено!`);
        }
        
        function deleteLift(liftId) {
            if (confirm(`Ви впевнені, що хочете видалити ліфт ${liftId}? Цю дію не можна скасувати.`)) {
                lifts = lifts.filter(l => l.id !== liftId);
                localStorage.setItem('lifts', JSON.stringify(lifts));
                
                // Also remove any issues associated with this lift
                issues = issues.filter(i => i.liftId !== liftId);
                localStorage.setItem('issues', JSON.stringify(issues));
                
                displayLifts();
                displayDashboardLifts();
                displayIssues();
                displayMyIssues();
                updateMapMarkers();
                
                alert(`Ліфт ${liftId} успішно видалено!`);
            }
        }
        
        function submitNewIssue() {
            const liftId = document.getElementById('newIssueLiftId').value.trim();
            const description = document.getElementById('newIssueDescription').value.trim();
            const priority = document.getElementById('newIssuePriority').value;
            const photoFile = document.getElementById('newIssuePhoto').files[0];
            
            if (!liftId || !description) {
                alert('ID ліфта та опис проблеми є обов\'язковими полями!');
                return;
            }
            
            if (!lifts.some(lift => lift.id === liftId)) {
                alert('Ліфт із таким ID не знайдено!');
                return;
            }
            
            const issueId = `issue_${Date.now()}`;
            const newIssue = {
                id: issueId,
                liftId,
                description,
                priority,
                client: user.email,
                assignedTechnician: '',
                status: 'Нова',
                createdAt: new Date().toISOString(),
                photo: photoFile ? URL.createObjectURL(photoFile) : null
            };
            
            issues.push(newIssue);
            localStorage.setItem('issues', JSON.stringify(issues));
            
            // Update lift status if it's not already broken
            const lift = lifts.find(l => l.id === liftId);
            if (lift && lift.status !== 'Поломка') {
                lift.status = 'Поломка';
                localStorage.setItem('lifts', JSON.stringify(lifts));
            }
            
            displayIssues();
            displayMyIssues();
            displayLifts();
            displayDashboardLifts();
            updateMapMarkers();
            toggleForm('newIssueForm');
            document.getElementById('addIssueForm').reset();
            
            alert(`Заявку ${issueId} успішно створено!`);
        }
        
        function sendIssueToEmail() {
            const liftId = document.getElementById('newIssueLiftId').value.trim();
            const description = document.getElementById('newIssueDescription').value.trim();
            const priority = document.getElementById('newIssuePriority').value;
            
            if (!liftId || !description) {
                alert('Заповніть ID ліфта та опис проблеми перед відправкою на email!');
                return;
            }
            
            const subject = encodeURIComponent(`Нова заявка на ремонт ліфта ${liftId}`);
            const body = encodeURIComponent(
                `ID Ліфта: ${liftId}\n\n` +
                `Опис проблеми:\n${description}\n\n` +
                `Пріоритет: ${priority}\n\n` +
                `Клієнт: ${user.email || 'Не вказано'}\n\n` +
                `Дата створення: ${new Date().toLocaleString()}`
            );
            
            const adminEmail = "admin@liftmasterpro.com";
            window.location.href = `mailto:${adminEmail}?subject=${subject}&body=${body}`;
        }
        
        function assignTechnician(issueId, technicianEmail) {
            const issue = issues.find(i => i.id === issueId);
            if (!issue) return;
            
            issue.assignedTechnician = technicianEmail;
            if (issue.status === 'Нова') {
                issue.status = 'В роботі';
            }
            
            localStorage.setItem('issues', JSON.stringify(issues));
            displayIssues();
            
            const technician = technicians.find(t => t.email === technicianEmail);
            alert(`Техніка ${technician ? technician.name : technicianEmail} призначено на заявку ${issueId}`);
        }
        
        function updateIssueStatus(issueId, status) {
            const issue = issues.find(i => i.id === issueId);
            if (!issue) return;
            
            issue.status = status;
            localStorage.setItem('issues', JSON.stringify(issues));
            
            displayIssues();
            displayMyIssues();
            
            alert(`Статус заявки ${issueId} змінено на "${status}"`);
        }
        
        function viewLiftDetails(liftId) {
            const lift = lifts.find(l => l.id === liftId);
            if (!lift) return;
            
            // In a real app, you would navigate to a details page or show a modal
            const details = `
                <h4>Деталі ліфта ${lift.id}</h4>
                <p><strong>Адреса:</strong> ${lift.address}</p>
                <p><strong>Статус:</strong> <span class="badge ${lift.status === 'Активний' ? 'bg-success' : 'bg-danger'}">${lift.status}</span></p>
                ${lift.type ? `<p><strong>Тип:</strong> ${lift.type}</p>` : ''}
                ${lift.brand ? `<p><strong>Марка:</strong> ${lift.brand}</p>` : ''}
                ${lift.capacity ? `<p><strong>Вантажопідйомність:</strong> ${lift.capacity}</p>` : ''}
                ${lift.installationDate ? `<p><strong>Дата встановлення:</strong> ${formatDate(lift.installationDate)}</p>` : ''}
                ${lift.lastMaintenance ? `<p><strong>Останнє ТО:</strong> ${formatDate(lift.lastMaintenance)}</p>` : ''}
                ${lift.owner ? `<p><strong>Власник:</strong> ${lift.owner}</p>` : ''}
                ${lift.photo ? `<img src="${lift.photo}" class="img-fluid mt-3" alt="Фото ліфта" style="max-height: 200px;">` : ''}
            `;
            
            // Simple modal-like display
            alert(details.replace(/<[^>]*>/g, '')); // Fallback for alert
            // In a real app, use Bootstrap modal or custom modal implementation
        }
        
        function viewIssueDetails(issueId) {
            const issue = issues.find(i => i.id === issueId);
            if (!issue) return;
            
            const lift = lifts.find(l => l.id === issue.liftId);
            const assignedTech = issue.assignedTechnician ? technicians.find(t => t.email === issue.assignedTechnician) : null;
            
            // In a real app, you would navigate to a details page or show a modal
            const details = `
                <h4>Деталі заявки ${issue.id}</h4>
                <p><strong>Ліфт:</strong> ${issue.liftId} (${lift ? lift.address : 'невідомо'})</p>
                <p><strong>Статус:</strong> <span class="badge ${issue.status === 'Нова' ? 'bg-secondary' : issue.status === 'В роботі' ? 'bg-primary' : 'bg-success'}">${issue.status}</span></p>
                <p><strong>Пріоритет:</strong> <span class="badge ${issue.priority === 'Високий' ? 'bg-danger' : issue.priority === 'Середній' ? 'bg-warning' : 'bg-info'}">${issue.priority}</span></p>
                <p><strong>Опис проблеми:</strong> ${issue.description}</p>
                <p><strong>Клієнт:</strong> ${issue.client}</p>
                <p><strong>Призначений технік:</strong> ${assignedTech ? assignedTech.name : 'Не призначено'}</p>
                <p><strong>Дата створення:</strong> ${formatDate(issue.createdAt)}</p>
                ${issue.photo ? `<img src="${issue.photo}" class="img-fluid mt-3" alt="Фото проблеми" style="max-height: 200px;">` : ''}
            `;
            
            // Simple modal-like display
            alert(details.replace(/<[^>]*>/g, '')); // Fallback for alert
            // In a real app, use Bootstrap modal or custom modal implementation
        }
        
        function updateStats() {
            const visibleLifts = user.role === 'client' ? lifts.filter(l => l.owner === user.email) : lifts;
            const activeLifts = visibleLifts.filter(l => l.status === 'Активний').length;
            const brokenLifts = visibleLifts.filter(l => l.status === 'Поломка').length;
            
            document.getElementById('activeLifts').textContent = activeLifts;
            document.getElementById('todayIssues').textContent = brokenLifts;
            
            // Calculate average response time (simplified)
            const clientIssues = user.role === 'client' ? issues.filter(i => i.client === user.email) : issues;
            const completedIssues = clientIssues.filter(i => i.status === 'Завершена');
            
            let avgResponseTime = 2; // Default value in hours
            if (completedIssues.length > 0) {
                // Simplified calculation - in a real app, you would calculate based on actual timestamps
                avgResponseTime = Math.round(completedIssues.length * 1.5);
            }
            
            document.getElementById('reclamationTime').textContent = `${avgResponseTime} год`;
        }
        
        function checkUrgentIssues() {
            const visibleIssues = user.role === 'client' ? issues.filter(i => i.client === user.email) : 
                                user.role === 'technician' ? issues.filter(i => i.assignedTechnician === user.email) : issues;
            
            const urgentIssues = visibleIssues.filter(i => i.status === 'Нова' && i.priority === 'Високий');
            const notification = document.getElementById('urgentNotification');
            
            if (urgentIssues.length > 0) {
                notification.style.display = 'block';
                notification.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Увага! У вас ${urgentIssues.length} термінов${urgentIssues.length === 1 ? 'а' : 'і'} заявк${urgentIssues.length === 1 ? 'а' : 'и'}, які потребують негайної уваги.
                    <button class="btn btn-sm btn-outline-light ms-3" onclick="showSection('issues')">
                        Переглянути
                    </button>
                `;
            } else {
                notification.style.display = 'none';
            }
        }
        
        function checkForNewAssignments() {
            if (user.role === 'technician') {
                const newAssignments = issues.filter(issue => 
                    issue.assignedTechnician === user.email && 
                    issue.status === 'Нова' &&
                    (!issue.lastViewedByTech || new Date(issue.lastViewedByTech) < new Date(Date.now() - 5 * 60 * 1000) // 5 minutes
                );
                
                if (newAssignments.length > 0) {
                    newAssignments.forEach(issue => {
                        // Mark as viewed
                        issue.lastViewedByTech = new Date().toISOString();
                        localStorage.setItem('issues', JSON.stringify(issues));
                        
                        // Show notification
                        const lift = lifts.find(l => l.id === issue.liftId);
                        const notification = `
                            <div class="alert alert-info alert-dismissible fade show" role="alert">
                                <strong>Нове завдання!</strong> Вам призначено заявку ${issue.id} для ліфта ${issue.liftId} (${lift ? lift.address : 'невідома адреса'}).
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-primary" onclick="showSection('issues')">
                                        Переглянути
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // In a real app, you would add this to a notifications container
                        console.log(`New assignment: ${issue.id}`);
                    });
                }
            }
        }
        
        function loadSettings() {
            document.getElementById('languageSelect').value = settings.language;
            document.getElementById('dateFormatSelect').value = settings.dateFormat;
            document.getElementById('timeZoneSelect').value = settings.timeZone;
            
            // Load user profile data
            document.getElementById('userName').value = user.name || '';
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userPhone').value = user.phone || '';
        }
        
        function saveSettings() {
            settings.language = document.getElementById('languageSelect').value;
            settings.dateFormat = document.getElementById('dateFormatSelect').value;
            settings.timeZone = document.getElementById('timeZoneSelect').value;
            
            // Save user profile data
            user.name = document.getElementById('userName').value.trim();
            user.phone = document.getElementById('userPhone').value.trim();
            
            localStorage.setItem('settings', JSON.stringify(settings));
            localStorage.setItem('user', JSON.stringify(user));
            
            // Apply language changes if needed
            if (settings.language === 'en') {
                // In a real app, you would implement proper i18n
                alert('Settings saved! Language changes will take effect after page reload.');
            } else {
                alert('Налаштування збережено!');
            }
        }
        
        function changePassword() {
            const newPassword = prompt('Введіть новий пароль:');
            if (newPassword) {
                alert('Пароль успішно змінено!');
                // In a real app, you would send this to the server to update
            }
        }
        
        function exportAllData() {
            const data = {
                user,
                lifts,
                issues,
                technicians,
                settings,
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `liftmaster_backup_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
        }
        
        function deleteAccount() {
            if (confirm('Ви впевнені, що хочете видалити свій акаунт? Ця дія є незворотною.')) {
                alert('Акаунт позначено для видалення. В реальному додатку тут буде виклик API для видалення.');
                // In a real app, you would call an API to delete the account
            }
        }
        
        function exportToCSV(type) {
            let data, headers, filename;
            
            switch(type) {
                case 'lifts':
                    data = filterData(lifts, 'lifts');
                    headers = ['ID', 'Адреса', 'Тип', 'Марка', 'Вантажопідйомність', 'Статус', 'Дата встановлення', 'Останнє ТО', 'Власник'];
                    filename = 'lifts_export.csv';
                    break;
                case 'issues':
                    data = filterData(issues, 'issues');
                    headers = ['ID', 'ID Ліфта', 'Опис', 'Пріоритет', 'Клієнт', 'Технік', 'Статус', 'Дата створення'];
                    filename = 'issues_export.csv';
                    break;
                case 'myIssues':
                    data = filterData(issues.filter(i => i.client === user.email), 'myIssues');
                    headers = ['ID', 'ID Ліфта', 'Опис', 'Пріоритет', 'Статус', 'Технік', 'Дата створення'];
                    filename = 'my_issues_export.csv';
                    break;
                default:
                    return;
            }
            
            let csv = headers.join(',') + '\n';
            
            data.forEach(item => {
                let row = [];
                
                switch(type) {
                    case 'lifts':
                        row = [
                            item.id,
                            `"${item.address}"`,
                            item.type || '',
                            item.brand || '',
                            item.capacity || '',
                            item.status,
                            item.installationDate ? formatDate(item.installationDate) : '',
                            item.lastMaintenance ? formatDate(item.lastMaintenance) : '',
                            item.owner || ''
                        ];
                        break;
                    case 'issues':
                    case 'myIssues':
                        const tech = item.assignedTechnician ? technicians.find(t => t.email === item.assignedTechnician) : null;
                        row = [
                            item.id,
                            item.liftId,
                            `"${item.description}"`,
                            item.priority,
                            item.client,
                            tech ? tech.name : item.assignedTechnician || '',
                            item.status,
                            item.createdAt ? formatDate(item.createdAt) : ''
                        ];
                        break;
                }
                
                csv += row.join(',') + '\n';
            });
            
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }
        
        function logout() {
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }
        
        function setupEventListeners() {
            // Check for new assignments periodically (every 5 minutes)
            setInterval(checkForNewAssignments, 5 * 60 * 1000);
            
            // Initial check
            checkForNewAssignments();
        }
    </script>
</body>
</html>